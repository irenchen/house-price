<!DOCTYPE html>
<html>
  <head>
    <title>房屋估價系統</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick-theme.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.2/css/bootstrap.min.css">
    <link rel='stylesheet' href='/stylesheets/style.css' />

  </head>
  <body>
    <div class="conatiner">
        <h1>房屋估價查詢</h1>
        <div id="slick">
          <div><img src="images/pic01.jpg" alt="pic01"></div>
          <div><img src="images/pic02.jpg" alt="pic02"></div>
          <div><img src="images/pic03.jpg" alt="pic03"></div>
        </div>
    </div>

    <div style="margin-top:50px;"></div>

    <div class="container">
      <form id="queryForm" action="">
        <div class="row">
            <div class="col-md-4 form-group">
                <label for="city">縣市</label>
                <select name="city" id="city" class="form-control" required>
                  <option value="1">台北市</option>
                  <option value="2">新北市</option>
                  <option value="3">桃園市</option>
                  <option value="4">台中市</option>
                  <option value="5">台南市</option>
                  <option value="6">高雄市</option>
                  <option value="7">新竹市</option>
                  <option value="8">新竹縣</option>
                  <option value="9">基隆市</option>
                  <option value="10">嘉義市</option>
                  <option value="11">嘉義縣</option>
                  <option value="12">宜蘭縣</option>
                  <option value="13">花蓮縣</option>
                  <option value="14">苗栗縣</option>
                  <option value="15">彰化縣</option>
                  <option value="16">南投縣</option>
                  <option value="17">雲林縣</option>
                  <option value="18">屏東縣</option>
                </select>
            </div>
            <div class="col-md-4 form-group">
              <label for="district">行政區</label>
              <select name="district" id="district" class="form-control" required>
                <option value="1">中正區</option>
                <option value="2">大同區</option>
                <option value="3">中山區</option>
                <option value="4">松山區</option>
                <option value="5">大安區</option>
                <option value="6">萬華區</option>
                <option value="7">信義區</option>
                <option value="8">士林區</option>
                <option value="9">北投區</option>
                <option value="10">內湖區</option>
                <option value="11">南港區</option>
                <option value="12">文山區</option>
              </select>
            </div>
        </div>
        <div class="row">
          <div class="col-md-8 form-group">
            <label for="address">完整地址</label>
            <input type="text" name="address" id="address" 
                   class="form-control" placeholder="test" required>
          </div>
        </div>
        <div class="row">
          <div class="col-md-2 control-group">
            <label for="category">房屋類型</label>
            <select name="category" id="category" class="form-control" required>
              <option value="1">套房</option>
              <option value="2">公寓(5層含以下無電梯)</option>
              <option value="3">華廈(10層含以下有電梯)</option>
              <option value="4">住宅大樓(11層含以上有電梯)</option>
              <option value="5">透天</option>
            </select>
          </div>
          <div class="col-md-2 form-group">
            <label for="story">樓層總數</label>
            <input type="number" class="form-control" 
                   name="story" id="story" required>
          </div>
          <div class="col-md-2 form-group">
              <label for="floor">所在樓層</label>
              <input type="number" class="form-control" 
                     name="floor" id="floor" required>
          </div>
          <div class="col-md-2 form-group">
              <label for="age">屋齡</label>
              <input type="number" class="form-control" 
                     name="age" id="age" required>
          </div>
          <div class="col-md-2 form-group">
              <label for="acre">坪數</label>
              <input type="number" class="form-control" 
                     name="acre" id="acre" value="30" required>
          </div>
        </div>
        <div class="row">
            <div class="col-md-2 form-group">
                <label for="park1">平面停車位</label>
                <input type="number" class="form-control" 
                       name="park1" id="park1" value="0" required>
            </div>
            <div class="col-md-2 form-group">
                <label for="park2">機械停車位</label>
                <input type="number" class="form-control" 
                       name="park2" id="park2" value="0" required>
            </div>
        </div>
        <div class="row">
            <div class="col-md-4 checkbox">
                <label for="managed">
                  <input type="checkbox" name="managed">有管理
                </label>
              </div>
              <div id="submit" class="col-md-4">
                  <button class="btn btn-default">Submit</button>
              </div>
              <div id="wait" class="col-md-4 hidden">
                  查詢中...
              </div>
              <div class="col-md-4">
                <span id="result"></span>
              </div>
        </div>

      </form>
      <div class="container" id="history">
        <h3 id="toggleHistory" style="text-align:center;cursor:pointer;">
          查詢紀錄(展開)
        </h3>
        <table class="table" id="historyTable">
          <thead>
              <tr>
                  <th>No.</th>
                  <th>縣市</th>
                  <th>行政區</th>
                  <th>完整地址</th>
                  <th>房屋類型</th>
                  <th>樓層總數</th>
                  <th>所在樓層</th>
                  <th>屋齡</th>
                  <th>坪數</th>
                  <th>平面車位</th>
                  <th>機械車位</th>
                  <th>房屋總價</th>
                </tr>
          </thead>
          <tbody>

          </tbody>

        </table>
      </div>

      <div>
        <div>
            <img src="images/query01.png" alt="query01" id="img1">
        </div>
        <div>
            <img src="images/query02.png" alt="query02" id="img2">
        </div>        
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.2/js/bootstrap.min.js"></script>

    <script>
      $(function() {
        var queryHistory = refreshHistory()

        $('#slick').slick({
          autoplay: true,
          autoplaySpeed: 2000,
          pauseOnFocus: true,
          pauseOnHover: true,
          dots: true,
          arrows: false,

        })

        $('form').on('submit', function(evt) {
          $('#result').empty()
          $('#submit').addClass('hidden')
          $('#wait').removeClass('hidden')
          evt.preventDefault()
          var form = document.getElementById('queryForm')
          var formData = new FormData(form)
          

          var queryTime = new Date().getTime()
          var queryString = $(this).serialize()
          var record = { queryTime, queryString }

        //   $.ajax({
        //     url: '/query/opt1',
        //     method: 'POST',
        //     data: $('#queryForm').serializeArray(),
        //     success: function(res) {
        //       console.log(res)
        //       if(res.result) {
        //         $('#result').html(res.result)
        //       }
        //       $('#submit').removeClass('hidden')
        //       $('#wait').addClass('hidden')
        //     },
        //     err: function(err) {
        //       console.log(err)
        //       $('#submit').removeClass('hidden')
        //       $('#wait').addClass('hidden')
        //     }
        //   })

          fetch('/query/opt2', {
            method: 'POST',
            body: formData
          })
          .then(res => res.json())
          .then(data => {
            console.log(data)
            $('#result').html(data.result)
            $('#submit').removeClass('hidden')
            $('#wait').addClass('hidden')

            if(data.result.includes('萬')) {
              // update localStorage queryHistory
              record.queryResult = data.result
              console.log(record)
              queryHistory.push(record)
              localStorage.setItem("queryHistory", JSON.stringify(queryHistory))
              refreshHistory()
            }

            // return fetch('/images/query01.png')
            return fetch('/image1')
          })
          .then(res => res.blob())
          .then(blob => {
            var objectURL = URL.createObjectURL(blob)
            document.getElementById('img1').src = objectURL
            return delay(3000)
          })
          .then(() => {
            return fetch('/images/query02.png')
          })
          .then(res => res.blob())
          .then(blob => {
            var objectURL = URL.createObjectURL(blob)
            document.getElementById('img2').src = objectURL
          })          
          .catch(console.log)

        })
          
      })

      $('#historyTable').hide()
      $('#toggleHistory').on('click', evt => {
        if($('#toggleHistory').text().includes('展開')) {
          $('#toggleHistory').text('查詢紀錄(隱藏)')
        } else {
          $('#toggleHistory').text('查詢紀錄(展開)')
        }
        $('#historyTable').toggle()
      })

      function delay(duration) {
        return new Promise((resolve, reject) => {
          setTimeout(function() {
            resolve('done')
          }, duration)
        })
      }

      function refreshHistory() {
        var queryHistory = localStorage.getItem("queryHistory") || "[]"
        queryHistory = JSON.parse(queryHistory)
        $('#historyTable tbody').empty()

        queryHistory.forEach((record, index) => {
          var queryString = record.queryString
          var query = decodeURIComponent(queryString)
          var queries = query.split("&")
          var child = `<tr><td>${index + 1}</td>`
          queries.forEach(q => {            
            child += `<td>${q.slice(q.indexOf("=") + 1)}</td>`
          })
          child += `<td>${record.queryResult}</td>`
          child += '</tr>'
          $('#historyTable tbody').append(child)
        })
        

        return queryHistory
      }

    </script>
  </body>
</html>
